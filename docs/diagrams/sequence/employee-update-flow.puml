@startuml Employee Update - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Employee Update - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Employee Controller" as Controller
participant "Employee Service" as Service
participant "Validation Service" as Validation
participant "Employee Mapper" as Mapper
participant "Employee Repository" as Repository
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Navigate to employee details
User -> Frontend: 2. Click "Edit" button
Frontend -> Gateway: 3. GET /api/employees/{id}
Gateway -> Controller: 3a. Forward request
Controller -> Service: 3b. getById(employeeId)
Service -> Repository: 3c. findById(employeeId)
Repository -> DB: 3d. SELECT * FROM employee WHERE id = ?
DB --> Repository: 3e. Employee (with manager_id)
Repository --> Service: 3f. Employee entity
Service -> Mapper: 3g. toResponseDTO(Employee)
Mapper --> Service: 3h. EmployeeResponseDTO\n(with managerId)
Service --> Controller: 3i. EmployeeResponseDTO
Controller --> Gateway: 3j. HTTP 200 OK
Gateway --> Frontend: 3k. Employee data
Frontend -> Frontend: 3l. Load employee data and display edit form
Frontend -> Gateway: 3m. GET /api/employees/{managerId}\n(if managerId exists)
Gateway -> Controller: 3n. Forward request
Controller -> Service: 3o. getById(managerId)
Service -> Repository: 3p. findById(managerId)
Repository -> DB: 3q. SELECT * FROM employee WHERE id = ?
DB --> Repository: 3r. Manager entity
Repository --> Service: 3s. Employee
Service -> Mapper: 3t. toResponseDTO(Employee)
Mapper --> Service: 3u. EmployeeResponseDTO
Service --> Controller: 3v. EmployeeResponseDTO
Controller --> Gateway: 3w. HTTP 200 OK
Gateway --> Frontend: 3x. Manager data
Frontend -> Frontend: 3y. Pre-populate typeahead with manager
User -> Frontend: 4. Modify employee information\n(name, designation, salary, etc.)
User -> Frontend: 5. Optionally change department or location
User -> Frontend: 6. Optionally search and change manager\nusing typeahead component
Frontend -> Frontend: 6a. Typeahead: User types employee name/email\n(minimum 2 characters, filtered by department)
Frontend -> Gateway: 6b. GET /api/employees/search?q={searchTerm}&departmentId={deptId}
Gateway -> Controller: 6c. Forward search request
Controller -> Service: 6d. searchEmployees(searchTerm, departmentId, excludeId)
Service -> Repository: 6e. Search employees by name/email\nfiltered by department, excluding current employee
Repository -> DB: 6f. SELECT * FROM employee WHERE...\nAND department_id = ? AND id != ?
DB --> Repository: 6g. Matching employees in department
Repository --> Service: 6h. List<Employee>
Service --> Controller: 6i. EmployeeResponseDTO[]
Controller --> Gateway: 6j. HTTP 200 OK
Gateway --> Frontend: 6k. Employee list for typeahead\n(filtered by department)
Frontend -> Frontend: 6l. Display employee suggestions\n(name, email, designation)
User -> Frontend: 6m. Select manager from typeahead (or clear)
Frontend -> Frontend: 6n. Store selected manager ID (or null)
User -> Frontend: 7. Click "Save Changes"

Frontend -> Gateway: 8. PUT /api/employees/{id}\n(EmployeeRequestDTO)\nAuthorization: Bearer {token}

Gateway -> Gateway: 9. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 10. Intercept request
JwtFilter -> JwtFilter: 11. Validate JWT token
JwtFilter -> JwtFilter: 12. Extract role from token
JwtFilter -> JwtFilter: 13. Set SecurityContext
JwtFilter -> Controller: 14. Forward request

Controller -> Controller: 15. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('HR_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 16. HTTP 403 Forbidden
    Gateway --> Frontend: 17. Access denied
    Frontend --> User: 18. Show error message
else Authorized
    Controller -> SecurityService: 19. getCurrentUserRole()
    SecurityService --> Controller: 20. Role (e.g., 'HR_MANAGER')
    
    Controller -> Service: 21. update(employeeId, EmployeeRequestDTO)
    
    Service -> Repository: 22. findById(employeeId)
    Repository -> DB: 23. SELECT * FROM employee WHERE id = ?
    DB --> Repository: 24. Employee data
    Repository --> Service: 25. Existing Employee entity
    
    alt Employee not found
        Service --> Controller: 26. Throw EmployeeNotFoundException
        Controller --> Gateway: 27. HTTP 404 Not Found
        Gateway --> Frontend: 28. Error response
        Frontend --> User: 29. Show error: "Employee not found"
    else Employee found
        alt Department changed
            Service -> DeptRepo: 30. findById(newDepartmentId)
            DeptRepo -> DB: 31. SELECT * FROM department WHERE id = ?
            DB --> DeptRepo: 32. Department data
            DeptRepo --> Service: 33. New Department entity
            
            alt Department not found
                Service --> Controller: 34. Throw DepartmentNotFoundException
                Controller --> Gateway: 35. HTTP 404 Not Found
                Gateway --> Frontend: 36. Error response
                Frontend --> User: 37. Show error: "Department not found"
            end
        end
        
        alt Location changed
            Service -> LocRepo: 38. findById(newLocationId)
            LocRepo -> DB: 39. SELECT * FROM location WHERE id = ?
            DB --> LocRepo: 40. Location data
            LocRepo --> Service: 41. New Location entity
            
            alt Location not found
                Service --> Controller: 42. Throw LocationNotFoundException
                Controller --> Gateway: 43. HTTP 404 Not Found
                Gateway --> Frontend: 44. Error response
                Frontend --> User: 45. Show error: "Location not found"
            end
        end
        
        alt Manager is provided (not null)
            Service -> Repository: 46. getById(managerId)
            Repository -> DB: 47. SELECT * FROM employee WHERE id = ?
            DB --> Repository: 48. Manager entity
            Repository --> Service: 49. Manager
            
            Service -> Validation: 50. validateManagerInDepartment(managerId, departmentId)
            Validation -> Validation: 51. Check manager.departmentId == employee.departmentId
            
            alt Manager in different department
                Validation --> Service: 52. Validation failed
                Service --> Controller: 53. Throw ValidationException\n"Manager must be in same department"
                Controller --> Gateway: 54. HTTP 400 Bad Request
                Gateway --> Frontend: 55. Error response
                Frontend --> User: 56. Show error: "Manager must be in the same department as the employee"
            else Manager in same department
                Validation --> Service: 57. Validation passed
            end
        else Manager is null (cleared)
            Service -> Service: 58. Set manager = null
        end
        
        Service -> Service: 58. Validate other fields\n(salary > 0, performance rating 0-5.0, etc.)
        
        alt Validation fails
            Service --> Controller: 59. Throw ValidationException
            Controller --> Gateway: 60. HTTP 400 Bad Request
            Gateway --> Frontend: 61. Error response
            Frontend --> User: 62. Show validation errors
        else Validation passes
            Service -> Mapper: 59. toEntity(DTO, dept, loc, mgr)
            Mapper --> Service: 60. Updated Employee entity
            Service -> Service: 61. Set ID and joiningDate from existing
            
            Service -> Repository: 62. save(Employee)
            Repository -> DB: 63. UPDATE employee SET ...\n(including manager_id or NULL)\nWHERE id = ?
            DB --> Repository: 64. Updated employee
            Repository --> Service: 65. Employee entity
            
            Service -> Mapper: 66. toResponseDTO(Employee)
            Mapper --> Service: 67. EmployeeResponseDTO\n(with managerId)
            
            Service --> Controller: 68. EmployeeResponseDTO
            Controller --> Gateway: 69. HTTP 200 OK
            Gateway --> Frontend: 70. Response with updated employee\n(including managerId)
            
            participant "Employee Form Component" as FormComp
            participant "Employee List Component" as ListComp
            
            Frontend -> FormComp: 71. Emit employeeResponse (DialogData)
            FormComp -> ListComp: 72. Close dialog with response
            ListComp -> ListComp: 73. afterClosed() subscription triggers\n(with take(1) and isRefreshing guard)
            ListComp -> Gateway: 74. POST /api/employees (query with pagination)
            Gateway -> Controller: 75. Forward query request
            Controller -> Service: 76. query(page, size, sortBy, sortDir)
            Service -> Repository: 77. findAllFilteredByRole(pageable, role, deptId)
            Repository -> DB: 78. SELECT * FROM employee\nWHERE ... ORDER BY ... LIMIT ... OFFSET ...
            DB --> Repository: 79. Paginated employees\n(with manager_id)
            Repository --> Service: 80. Page<Employee>
            Service -> Mapper: 81. toResponseDTO() for each employee
            Mapper --> Service: 82. EmployeeResponseDTO[]\n(with managerId)
            Service --> Controller: 83. PaginatedResponseDTO<Employee>
            Controller --> Gateway: 84. HTTP 200 OK
            Gateway --> ListComp: 85. Updated employee list\n(with managerId)
            ListComp -> ListComp: 86. Update table data
            ListComp -> User: 87. Display updated employee list\nwith changes reflected\n(including manager if assigned)
        end
    end
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role (HR_MANAGER/SYSTEM_ADMIN)
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  Only HR_MANAGER and
  SYSTEM_ADMIN can update
end note

note right of Validation
  **Business Rules:**
  - Manager must be in same department
  - Salary must be positive
  - Performance rating: 0.0-5.0
  - Email is immutable
  - Joining date is immutable
  - Typeahead filters by
    department automatically
end note

note right of Frontend
  **Typeahead Component:**
  - Pre-loads current manager if exists
  - Filters managers by department
  - Provides autocomplete search
  - Searches employees by name/email
  - Displays employee suggestions
  - Stores selected manager ID or null
  - Validates selection before submit
  - Disabled until department selected
  - Excludes current employee in edit mode
end note

@enduml

