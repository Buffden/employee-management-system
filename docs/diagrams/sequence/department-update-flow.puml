@startuml Department Update - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Department Update - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Department Controller" as Controller
participant "Department Service" as Service
participant "Department Mapper" as Mapper
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
participant "Employee Repository" as EmpRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Navigate to department details
User -> Frontend: 2. Click "Edit" button
Frontend -> Gateway: 3. GET /api/departments/{id}
Gateway -> Controller: 3a. Forward request
Controller -> Service: 3b. getById(departmentId)
Service -> DeptRepo: 3c. findById(departmentId)
DeptRepo -> DB: 3d. SELECT * FROM department WHERE id = ?
DB --> DeptRepo: 3e. Department (with department_head_id)
DeptRepo --> Service: 3f. Department entity
Service -> Mapper: 3g. toResponseDTO(Department)
Mapper --> Service: 3h. DepartmentResponseDTO\n(with departmentHeadId)
Service --> Controller: 3i. DepartmentResponseDTO
Controller --> Gateway: 3j. HTTP 200 OK
Gateway --> Frontend: 3k. Department data
Frontend -> Frontend: 3l. Load department data and display edit form
Frontend -> Gateway: 3m. GET /api/employees/{departmentHeadId}\n(if departmentHeadId exists)
Gateway -> Controller: 3n. Forward request
Controller -> EmployeeService: 3o. getById(departmentHeadId)
EmployeeService -> EmpRepo: 3p. findById(departmentHeadId)
EmpRepo -> DB: 3q. SELECT * FROM employee WHERE id = ?
DB --> EmpRepo: 3r. Employee entity
EmpRepo --> EmployeeService: 3s. Employee
EmployeeService --> Controller: 3t. EmployeeResponseDTO
Controller --> Gateway: 3u. HTTP 200 OK
Gateway --> Frontend: 3v. Employee data
Frontend -> Frontend: 3w. Pre-populate typeahead with employee
User -> Frontend: 4. Modify department information\n(name, description, budget)
User -> Frontend: 5. Optionally change location
User -> Frontend: 6. Optionally search and change department head\nusing typeahead component
Frontend -> Frontend: 6a. Typeahead: User types employee name/email
Frontend -> Gateway: 6b. GET /api/employees/search?q={searchTerm}
Gateway -> Controller: 6c. Forward search request
Controller -> EmployeeService: 6d. searchEmployees(searchTerm)
EmployeeService -> EmpRepo: 6e. Search employees by name/email
EmpRepo -> DB: 6f. SELECT * FROM employee WHERE...
DB --> EmpRepo: 6g. Matching employees
EmpRepo --> EmployeeService: 6h. List<Employee>
EmployeeService --> Controller: 6i. EmployeeResponseDTO[]
Controller --> Gateway: 6j. HTTP 200 OK
Gateway --> Frontend: 6k. Employee list for typeahead
Frontend -> Frontend: 6l. Display employee suggestions
User -> Frontend: 6m. Select employee from typeahead (or clear)
Frontend -> Frontend: 6n. Store selected employee ID (or null)
User -> Frontend: 7. Click "Save Changes"

Frontend -> Gateway: 8. PUT /api/departments/{id}\n(DepartmentRequestDTO)\nAuthorization: Bearer {token}

Gateway -> Gateway: 9. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 10. Intercept request
JwtFilter -> JwtFilter: 11. Validate JWT token
JwtFilter -> JwtFilter: 12. Extract role from token
JwtFilter -> JwtFilter: 13. Set SecurityContext
JwtFilter -> Controller: 14. Forward request

Controller -> Controller: 15. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('HR_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 16. HTTP 403 Forbidden
    Gateway --> Frontend: 17. Access denied
    Frontend --> User: 18. Show error message
else Authorized
    Controller -> SecurityService: 19. getCurrentUserRole()
    SecurityService --> Controller: 20. Role (e.g., 'HR_MANAGER')
    
    Controller -> Controller: 21. Extract departmentHeadId from DTO
    
    alt Department head is provided
        Controller -> EmployeeService: 22. getById(departmentHeadId)
        EmployeeService -> EmpRepo: 23. findById(departmentHeadId)
        EmpRepo -> DB: 24. SELECT * FROM employee WHERE id = ?
        DB --> EmpRepo: 25. Employee entity
        EmpRepo --> EmployeeService: 26. Employee
        EmployeeService --> Controller: 27. Employee (department head)
        
        alt Employee not found
            Controller --> Gateway: 28. HTTP 400 Bad Request\n"Employee not found"
            Gateway --> Frontend: 29. Error response
            Frontend --> User: 30. Display error: "Department head not found"
        else Employee found
            Controller -> Service: 31. update(departmentId, DepartmentRequestDTO, location, head)
        end
    else No department head (null)
        Controller -> Service: 31. update(departmentId, DepartmentRequestDTO, location, null)
    end
    
    Service -> DeptRepo: 32. findById(departmentId)
    DeptRepo -> DB: 33. SELECT * FROM department WHERE id = ?
    DB --> DeptRepo: 34. Department data
    DeptRepo --> Service: 35. Existing Department entity
    
    alt Department not found
        Service --> Controller: 36. Throw DepartmentNotFoundException
        Controller --> Gateway: 37. HTTP 404 Not Found
        Gateway --> Frontend: 38. Error response
        Frontend --> User: 39. Show error: "Department not found"
    else Department found
        alt Location changed
            Service -> LocRepo: 40. findById(newLocationId)
            LocRepo -> DB: 41. SELECT * FROM location WHERE id = ?
            DB --> LocRepo: 42. Location data
            LocRepo --> Service: 43. New Location entity
            
            alt Location not found
                Service --> Controller: 44. Throw LocationNotFoundException
                Controller --> Gateway: 45. HTTP 404 Not Found
                Gateway --> Frontend: 46. Error response
                Frontend --> User: 47. Show error: "Location not found"
            end
        end
        
        alt Name changed
            Service -> DeptRepo: 48. existsByNameAndIdNot(name, departmentId)
            DeptRepo -> DB: 49. SELECT COUNT(*) FROM department\nWHERE name = ? AND id != ?
            DB --> DeptRepo: 50. Count result
            DeptRepo --> Service: 51. Name exists? (boolean)
            
            alt Name already exists
                Service --> Controller: 52. Throw DuplicateNameException
                Controller --> Gateway: 53. HTTP 400 Bad Request
                Gateway --> Frontend: 54. Error response
                Frontend --> User: 55. Show error: "Department name already exists"
            end
        end
        
        Service -> Service: 56. Validate other fields\n(budget >= 0, etc.)
        
        alt Validation fails
            Service --> Controller: 57. Throw ValidationException
            Controller --> Gateway: 58. HTTP 400 Bad Request
            Gateway --> Frontend: 59. Error response
            Frontend --> User: 60. Show validation errors
        else Validation passes
            Service -> Mapper: 61. toEntity(DTO, location, head)
            Mapper --> Service: 62. Updated Department entity
            Service -> Service: 63. Set ID and createdAt from existing
            
            Service -> Service: 64. Validate department head changes\n(if head is being changed)
            
            alt New head is assigned
                Service -> DeptRepo: 65. findDepartmentsByHeadId(newHead.id)
                DeptRepo -> DB: 66. SELECT * FROM department\nWHERE department_head_id = ?
                DB --> DeptRepo: 67. List<Department> (if head of other dept)
                DeptRepo --> Service: 68. Departments where employee is head
                
                alt Employee already head of different department
                    Service --> Controller: 69. Throw IllegalStateException\n"Employee already head of department X"
                    Controller --> Gateway: 70. HTTP 400 Bad Request
                    Gateway --> Frontend: 71. Error response
                    Frontend --> User: 72. Display error: "Employee already head\nof another department"
                else Employee can be assigned
                    Service -> DeptRepo: 73. save(Department)
                    DeptRepo -> DB: 74. UPDATE department SET ...\n(including department_head_id)\nWHERE id = ?
                    DB --> DeptRepo: 75. Updated department
                    DeptRepo --> Service: 76. Department entity
                    
                    Service -> Service: 77. Synchronize head's department_id
                    Service -> EmployeeService: 78. getById(head.id)
                    EmployeeService -> EmpRepo: 79. findById(head.id)
                    EmpRepo -> DB: 80. SELECT * FROM employee WHERE id = ?
                    DB --> EmpRepo: 81. Employee entity
                    EmpRepo --> EmployeeService: 82. Employee
                    EmployeeService --> Service: 83. Employee (head)
                    
                    alt Employee's department != this department
                        Service -> EmployeeService: 84. Update employee.department_id\nto match this department
                        EmployeeService -> EmployeeService: 85. Validate manager in same department\n(if employee has reports)
                        
                        alt Validation fails (reports in different dept)
                            EmployeeService --> Service: 86. Throw IllegalArgumentException\n"Manager must be in same department"
                            Service --> Controller: 87. HTTP 400 Bad Request
                            Controller --> Gateway: 88. Error response
                            Gateway --> Frontend: 89. Error response
                            Frontend --> User: 90. Display error: "Cannot assign head\nwith reports in different department"
                        else Validation passes
                            EmployeeService -> EmpRepo: 91. save(Employee with updated department_id)
                            EmpRepo -> DB: 92. UPDATE employee SET department_id = ?\nWHERE id = ?
                            DB --> EmpRepo: 93. Updated employee
                            EmpRepo --> EmployeeService: 94. Employee
                            EmployeeService --> Service: 95. Head synchronized
                        end
                    else Employee's department already matches
                        Service -> Service: 96. No update needed\n(head already in correct department)
                    end
                end
            else No head or head unchanged
                Service -> DeptRepo: 73. save(Department)
                DeptRepo -> DB: 74. UPDATE department SET ...\nWHERE id = ?
                DB --> DeptRepo: 75. Updated department
                DeptRepo --> Service: 76. Department entity
            end
            
            Service -> Mapper: 68. toResponseDTO(Department)
            Mapper -> Mapper: 69. Extract departmentHeadId and departmentHeadName
            Mapper --> Service: 70. DepartmentResponseDTO\n(with departmentHeadId)
            
    Service --> Controller: 71. DepartmentResponseDTO
    Controller --> Gateway: 72. HTTP 200 OK
    Gateway --> Frontend: 73. Response with updated department\n(including departmentHeadId)
    
    participant "Department Form Component" as FormComp
    participant "Department List Component" as ListComp
    
    Frontend -> FormComp: 74. Emit departmentResponse (DialogData)
    FormComp -> ListComp: 75. Close dialog with response
    ListComp -> ListComp: 76. afterClosed() subscription triggers\n(with take(1) and isRefreshing guard)
    ListComp -> Gateway: 77. POST /api/departments (query with pagination)
    Gateway -> Controller: 78. Forward query request
    Controller -> Service: 79. query(page, size, sortBy, sortDir)
    Service -> DeptRepo: 80. findAll(pageable)
    DeptRepo -> DB: 81. SELECT * FROM department\nORDER BY ... LIMIT ... OFFSET ...
    DB --> DeptRepo: 82. Paginated departments\n(with department_head_id)
    DeptRepo --> Service: 83. Page<Department>
    Service -> Mapper: 84. toResponseDTO() for each department
    Mapper --> Service: 85. DepartmentResponseDTO[]\n(with departmentHeadId)
    Service --> Controller: 86. PaginatedResponseDTO<Department>
    Controller --> Gateway: 87. HTTP 200 OK
    Gateway --> ListComp: 88. Updated department list\n(with departmentHeadId)
    ListComp -> ListComp: 89. Update table data
    ListComp -> User: 90. Display updated department list\nwith changes reflected\n(including department head)
        end
    end
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role (HR_MANAGER/SYSTEM_ADMIN)
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  Only HR_MANAGER and
  SYSTEM_ADMIN can update departments
end note

note right of Service
  **Business Rules:**
  - Name must remain unique (if changed)
  - Budget must be non-negative
  - Location must exist (if changed)
  - Department Head must exist (if changed)
  - Employee can only be head of ONE department
  - Department head's department_id must match
  - Head's direct reports must be in same department
  - Controller validates employee before
    passing to service
  **Bidirectional Sync:**
  - Updates employee.department_id when
    assigning/changing department head
  - Old head keeps department_id (still works there)
end note

note right of Frontend
  **Typeahead Component:**
  - Pre-loads current employee if exists
  - Provides autocomplete search
  - Searches employees by name/email
  - Displays employee suggestions
  - Stores selected employee ID or null
  - Validates selection before submit
end note

note right of ListComp
  **Refresh Pattern (Edit/Delete Operations):**
  - List component opens edit dialog
  - Form emits response via @Output
  - List's afterClosed() with take(1)
    and isRefreshing guard refreshes
  - Ensures single refresh call
  - Prevents duplicate network requests
end note

@enduml

