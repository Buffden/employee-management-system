@startuml Department Update - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Department Update - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Department Controller" as Controller
participant "Department Service" as Service
participant "Department Mapper" as Mapper
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
participant "Employee Repository" as EmpRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Navigate to department details
User -> Frontend: 2. Click "Edit" button
Frontend -> Frontend: 3. Load department data and display edit form
User -> Frontend: 4. Modify department information\n(name, description, budget)
User -> Frontend: 5. Optionally change location
User -> Frontend: 6. Optionally change department head
User -> Frontend: 7. Click "Save Changes"

Frontend -> Gateway: 8. PUT /api/departments/{id}\n(DepartmentRequestDTO)\nAuthorization: Bearer {token}

Gateway -> Gateway: 9. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 10. Intercept request
JwtFilter -> JwtFilter: 11. Validate JWT token
JwtFilter -> JwtFilter: 12. Extract role from token
JwtFilter -> JwtFilter: 13. Set SecurityContext
JwtFilter -> Controller: 14. Forward request

Controller -> Controller: 15. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('HR_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 16. HTTP 403 Forbidden
    Gateway --> Frontend: 17. Access denied
    Frontend --> User: 18. Show error message
else Authorized
    Controller -> SecurityService: 19. getCurrentUserRole()
    SecurityService --> Controller: 20. Role (e.g., 'HR_MANAGER')
    
    Controller -> Service: 21. update(departmentId, DepartmentRequestDTO)
    
    Service -> DeptRepo: 22. findById(departmentId)
    DeptRepo -> DB: 23. SELECT * FROM department WHERE id = ?
    DB --> DeptRepo: 24. Department data
    DeptRepo --> Service: 25. Existing Department entity
    
    alt Department not found
        Service --> Controller: 26. Throw DepartmentNotFoundException
        Controller --> Gateway: 27. HTTP 404 Not Found
        Gateway --> Frontend: 28. Error response
        Frontend --> User: 29. Show error: "Department not found"
    else Department found
        alt Location changed
            Service -> LocRepo: 30. findById(newLocationId)
            LocRepo -> DB: 31. SELECT * FROM location WHERE id = ?
            DB --> LocRepo: 32. Location data
            LocRepo --> Service: 33. New Location entity
            
            alt Location not found
                Service --> Controller: 34. Throw LocationNotFoundException
                Controller --> Gateway: 35. HTTP 404 Not Found
                Gateway --> Frontend: 36. Error response
                Frontend --> User: 37. Show error: "Location not found"
            end
        end
        
        alt Department Head changed
            Service -> EmpRepo: 38. findById(newDepartmentHeadId)
            EmpRepo -> DB: 39. SELECT * FROM employee WHERE id = ?
            DB --> EmpRepo: 40. Employee data
            EmpRepo --> Service: 41. Department Head entity
            
            alt Department Head not found
                Service --> Controller: 42. Throw EmployeeNotFoundException
                Controller --> Gateway: 43. HTTP 404 Not Found
                Gateway --> Frontend: 44. Error response
                Frontend --> User: 45. Show error: "Department Head not found"
            end
        end
        
        alt Name changed
            Service -> DeptRepo: 46. existsByNameAndIdNot(name, departmentId)
            DeptRepo -> DB: 47. SELECT COUNT(*) FROM department\nWHERE name = ? AND id != ?
            DB --> DeptRepo: 48. Count result
            DeptRepo --> Service: 49. Name exists? (boolean)
            
            alt Name already exists
                Service --> Controller: 50. Throw DuplicateNameException
                Controller --> Gateway: 51. HTTP 400 Bad Request
                Gateway --> Frontend: 52. Error response
                Frontend --> User: 53. Show error: "Department name already exists"
            end
        end
        
        Service -> Service: 54. Validate other fields\n(budget >= 0, etc.)
        
        alt Validation fails
            Service --> Controller: 55. Throw ValidationException
            Controller --> Gateway: 56. HTTP 400 Bad Request
            Gateway --> Frontend: 57. Error response
            Frontend --> User: 58. Show validation errors
        else Validation passes
            Service -> Mapper: 59. updateEntity(existingDepartment, DTO, loc, head)
            Mapper --> Service: 60. Updated Department entity
            
            Service -> DeptRepo: 61. save(Department)
            DeptRepo -> DB: 62. UPDATE department SET ... WHERE id = ?
            DB --> DeptRepo: 63. Updated department
            DeptRepo --> Service: 64. Department entity
            
            Service -> Mapper: 65. toResponseDTO(Department)
            Mapper --> Service: 66. DepartmentResponseDTO
            
            Service --> Controller: 67. DepartmentResponseDTO
            Controller --> Gateway: 68. HTTP 200 OK
            Gateway --> Frontend: 69. Response with updated department
            Frontend -> User: 70. Display success: "Department updated successfully"
            Frontend -> Frontend: 71. Refresh department details view
        end
    end
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role (HR_MANAGER/SYSTEM_ADMIN)
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  Only HR_MANAGER and
  SYSTEM_ADMIN can update departments
end note

note right of Service
  **Business Rules:**
  - Name must remain unique (if changed)
  - Budget must be non-negative
  - Location must exist (if changed)
  - Department Head must exist (if changed)
end note

@enduml

