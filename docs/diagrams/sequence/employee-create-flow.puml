@startuml Employee Create - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Employee Create - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Employee Controller" as Controller
participant "Employee Service" as Service
participant "Validation Service" as Validation
participant "Employee Mapper" as Mapper
participant "Employee Repository" as Repository
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Fill employee form (name, email, salary, etc.)
User -> Frontend: 2. Select department & location
User -> Frontend: 3. Optionally select manager
User -> Frontend: 4. Click "Create Employee"

Frontend -> Gateway: 5. POST /api/employees (EmployeeRequestDTO)\nAuthorization: Bearer {token}
Gateway -> Gateway: 6. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 7. Intercept request
JwtFilter -> JwtFilter: 8. Validate JWT token
JwtFilter -> JwtFilter: 9. Extract role from token
JwtFilter -> JwtFilter: 10. Set SecurityContext
JwtFilter -> Controller: 11. Forward request

Controller -> Controller: 12. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('HR_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 13. HTTP 403 Forbidden
    Gateway --> Frontend: 14. Access denied
    Frontend --> User: 15. Show error message
else Authorized
    Controller -> SecurityService: 16. getCurrentUserRole()
    SecurityService --> Controller: 17. Role (e.g., 'HR_MANAGER')
    
    Controller -> Service: 18. create(EmployeeRequestDTO)

alt Manager is provided
    Service -> Validation: 8. validateManagerInDepartment(managerId, departmentId)
    Validation -> DeptRepo: 9. Check manager's department
    DeptRepo -> DB: 10. Query employee department
    DB --> DeptRepo: 11. Department data
    DeptRepo --> Validation: 12. Department info
    Validation --> Service: 13. Validation result
end

Service -> DeptRepo: 14. getById(departmentId)
DeptRepo -> DB: 15. SELECT department
DB --> DeptRepo: 16. Department entity
DeptRepo --> Service: 17. Department

Service -> LocRepo: 18. getById(locationId)
LocRepo -> DB: 19. SELECT location
DB --> LocRepo: 20. Location entity
LocRepo --> Service: 21. Location

alt Manager provided
    Service -> Repository: 22. getById(managerId)
    Repository -> DB: 23. SELECT employee
    DB --> Repository: 24. Manager entity
    Repository --> Service: 25. Manager
end

Service -> Mapper: 26. toEntity(DTO, dept, loc, mgr)
Mapper --> Service: 27. Employee entity

Service -> Repository: 28. save(Employee)
Repository -> DB: 29. INSERT employee
DB --> Repository: 30. Saved employee
Repository --> Service: 31. Employee

Service -> Mapper: 32. toResponseDTO(Employee)
Mapper --> Service: 33. EmployeeResponseDTO

Service --> Controller: 40. EmployeeResponseDTO
Controller --> Gateway: 41. HTTP 201 Created
Gateway --> Frontend: 42. Response with employee data
Frontend -> User: 43. Display success message and employee details

note right of Validation
  Business Rule:
  Manager must be in
  same department
end note

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role (HR_MANAGER/SYSTEM_ADMIN)
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  before method execution
  Only HR_MANAGER and
  SYSTEM_ADMIN can create
end note

note right of Mapper
  Adapter Pattern:
  Converts DTO â†” Entity
end note

@enduml

