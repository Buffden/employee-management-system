@startuml Employee Create - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Employee Create - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Employee Controller" as Controller
participant "Employee Service" as Service
participant "Validation Service" as Validation
participant "Employee Mapper" as Mapper
participant "Employee Repository" as Repository
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Fill employee form (name, email, salary, etc.)
User -> Frontend: 2. Select department & location from dropdowns
User -> Frontend: 3. Optionally search and select manager\nusing typeahead component
Frontend -> Frontend: 3a. Typeahead: User types employee name/email\n(minimum 2 characters, filtered by department)
Frontend -> Gateway: 3b. GET /api/employees/search?q={searchTerm}&departmentId={deptId}
Gateway -> Controller: 3c. Forward search request
Controller -> Service: 3d. searchEmployees(searchTerm, departmentId)
Service -> Repository: 3e. Search employees by name/email\nfiltered by department
Repository -> DB: 3f. SELECT * FROM employee WHERE...\nAND department_id = ?
DB --> Repository: 3g. Matching employees in department
Repository --> Service: 3h. List<Employee>
Service --> Controller: 3i. EmployeeResponseDTO[]
Controller --> Gateway: 3j. HTTP 200 OK
Gateway --> Frontend: 3k. Employee list for typeahead\n(filtered by department)
Frontend -> Frontend: 3l. Display employee suggestions\n(name, email, designation)
User -> Frontend: 3m. Select manager from typeahead
Frontend -> Frontend: 3n. Store selected manager ID
User -> Frontend: 4. Click "Create Employee"

Frontend -> Gateway: 5. POST /api/employees (EmployeeRequestDTO)\nAuthorization: Bearer {token}
Gateway -> Gateway: 6. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 7. Intercept request
JwtFilter -> JwtFilter: 8. Validate JWT token
JwtFilter -> JwtFilter: 9. Extract role from token
JwtFilter -> JwtFilter: 10. Set SecurityContext
JwtFilter -> Controller: 11. Forward request

Controller -> Controller: 12. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('HR_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 13. HTTP 403 Forbidden
    Gateway --> Frontend: 14. Access denied
    Frontend --> User: 15. Show error message
else Authorized
    Controller -> SecurityService: 16. getCurrentUserRole()
    SecurityService --> Controller: 17. Role (e.g., 'HR_MANAGER')
    
    Controller -> Service: 18. create(EmployeeRequestDTO)

alt Manager is provided
    Service -> Repository: 19. getById(managerId)
    Repository -> DB: 20. SELECT * FROM employee WHERE id = ?
    DB --> Repository: 21. Manager entity
    Repository --> Service: 22. Manager
    
    Service -> Validation: 23. validateManagerInDepartment(managerId, departmentId)
    Validation -> Validation: 24. Check manager.departmentId == departmentId
    
    alt Manager in different department
        Validation --> Service: 25. Validation failed
        Service --> Controller: 26. Throw ValidationException\n"Manager must be in same department"
        Controller --> Gateway: 27. HTTP 400 Bad Request
        Gateway --> Frontend: 28. Error response
        Frontend --> User: 29. Display error: "Manager must be in the same department"
    else Manager in same department
        Validation --> Service: 30. Validation passed
    end
else No manager
    Service -> Service: 31. Set manager = null
end

Service -> DeptRepo: 32. getById(departmentId)
DeptRepo -> DB: 33. SELECT department
DB --> DeptRepo: 34. Department entity
DeptRepo --> Service: 35. Department

Service -> LocRepo: 36. getById(locationId)
LocRepo -> DB: 37. SELECT location
DB --> LocRepo: 38. Location entity
LocRepo --> Service: 39. Location

Service -> Mapper: 40. toEntity(DTO, dept, loc, mgr)
Mapper --> Service: 41. Employee entity

Service -> Repository: 42. save(Employee)
Repository -> DB: 43. INSERT employee\n(including manager_id if provided)
DB --> Repository: 44. Saved employee
Repository --> Service: 45. Employee

Service -> Mapper: 46. toResponseDTO(Employee)
Mapper --> Service: 47. EmployeeResponseDTO

    Service --> Controller: 48. EmployeeResponseDTO
    Controller --> Gateway: 49. HTTP 201 Created
    Gateway --> Frontend: 50. Response with employee data\n(including managerId)
    
    participant "Employee Form Component" as FormComp
    participant "Table Component" as TableComp
    participant "Employee List Component" as ListComp
    
    Frontend -> FormComp: 51. Emit employeeResponse (DialogData)
    FormComp -> TableComp: 52. Close dialog with response
    TableComp -> TableComp: 53. afterClosed() subscription triggers
    TableComp -> TableComp: 54. Dispatch 'employeeAdded' event
    TableComp -> ListComp: 55. Event listener receives 'employeeAdded'
    ListComp -> Gateway: 56. POST /api/employees (query with pagination)
    Gateway -> Controller: 57. Forward query request
    Controller -> Service: 58. query(page, size, sortBy, sortDir)
    Service -> Repository: 59. findAllFilteredByRole(pageable, role, deptId)
    Repository -> DB: 60. SELECT * FROM employee\nWHERE ... ORDER BY ... LIMIT ... OFFSET ...
    DB --> Repository: 61. Paginated employees\n(with manager_id)
    Repository --> Service: 62. Page<Employee>
    Service -> Mapper: 63. toResponseDTO() for each employee
    Mapper --> Service: 64. EmployeeResponseDTO[]\n(with managerId)
    Service --> Controller: 65. PaginatedResponseDTO<Employee>
    Controller --> Gateway: 66. HTTP 200 OK
    Gateway --> ListComp: 67. Updated employee list\n(with managerId)
    ListComp -> ListComp: 68. Update table data
    ListComp -> User: 69. Display updated employee list\nwith new employee included\n(including manager if assigned)

note right of Validation
  Business Rule:
  Manager must be in
  same department
  Typeahead filters by
  department automatically
end note

note right of Frontend
  **Typeahead Component:**
  - Filters managers by department
  - Provides autocomplete search
  - Searches employees by name/email
  - Displays employee suggestions
  - Stores selected manager ID
  - Validates selection before submit
  - Disabled until department selected
end note

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role (HR_MANAGER/SYSTEM_ADMIN)
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  before method execution
  Only HR_MANAGER and
  SYSTEM_ADMIN can create
end note

note right of Mapper
  Adapter Pattern:
  Converts DTO â†” Entity
end note

note right of TableComp
  **Refresh Pattern (Add Operations):**
  - Table component opens add dialog
  - Form emits response via @Output
  - Table's afterClosed() dispatches event
  - List component listens and refreshes
  - Ensures single refresh call
end note

note right of ListComp
  **List Refresh:**
  - Single API call to query endpoint
  - Maintains pagination, sorting, filters
  - Updates table data automatically
  - Role-based filtering applied
end note

@enduml

