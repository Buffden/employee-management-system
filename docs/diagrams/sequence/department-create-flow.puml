@startuml Department Create Flow
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Department Creation - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Department Controller" as Controller
participant "Department Service" as Service
participant "Department Mapper" as Mapper
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
participant "Employee Repository" as EmpRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Fill department form (name, description, budget)
User -> Frontend: 2. Select location from dropdown
User -> Frontend: 3. Optionally search and select department head\nusing typeahead component
Frontend -> Frontend: 3a. Typeahead: User types employee name/email
Frontend -> Gateway: 3b. GET /api/employees/search?q={searchTerm}
Gateway -> Controller: 3c. Forward search request
Controller -> Service: 3d. searchEmployees(searchTerm)
Service -> EmpRepo: 3e. Search employees by name/email
EmpRepo -> DB: 3f. SELECT * FROM employee WHERE...
DB --> EmpRepo: 3g. Matching employees
EmpRepo --> Service: 3h. List<Employee>
Service --> Controller: 3i. EmployeeResponseDTO[]
Controller --> Gateway: 3j. HTTP 200 OK
Gateway --> Frontend: 3k. Employee list for typeahead
Frontend -> Frontend: 3l. Display employee suggestions
User -> Frontend: 3m. Select employee from typeahead
Frontend -> Frontend: 3n. Store selected employee ID
User -> Frontend: 4. Click "Create Department"

Frontend -> Gateway: 5. POST /api/departments\nAuthorization: Bearer {token}\n(DepartmentRequestDTO)
Gateway -> Gateway: 6. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 7. Intercept request
JwtFilter -> JwtFilter: 8. Validate JWT token
JwtFilter -> JwtFilter: 9. Extract role from token
JwtFilter -> Controller: 10. Forward request

Controller -> Controller: 11. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN'))

alt Insufficient permissions
    Controller --> Gateway: 12. HTTP 403 Forbidden
    Gateway --> Frontend: 13. Access denied
    Frontend --> User: 14. Show error message
else Authorized
    Controller -> SecurityService: 15. getCurrentUserRole()
    SecurityService --> Controller: 16. Role (must be 'SYSTEM_ADMIN')
    
    Controller -> Controller: 17. Extract departmentHeadId from DTO
    
    alt Department head is provided
        Controller -> EmployeeService: 18. getById(departmentHeadId)
        EmployeeService -> EmpRepo: 19. findById(departmentHeadId)
        EmpRepo -> DB: 20. SELECT * FROM employee WHERE id = ?
        DB --> EmpRepo: 21. Employee entity
        EmpRepo --> EmployeeService: 22. Employee
        EmployeeService --> Controller: 23. Employee (department head)
        
        alt Employee not found
            Controller --> Gateway: 24. HTTP 400 Bad Request\n"Employee not found"
            Gateway --> Frontend: 25. Error response
            Frontend --> User: 26. Display error: "Department head not found"
        else Employee found
            Controller -> Service: 27. create(DepartmentRequestDTO, location, head)
        end
    else No department head
        Controller -> Service: 27. create(DepartmentRequestDTO, location, null)
    end

    Service -> LocRepo: 28. getById(locationId)
    LocRepo -> DB: 29. SELECT * FROM location WHERE id = ?
    DB --> LocRepo: 30. Location entity
    LocRepo --> Service: 31. Location

    Service -> Service: 32. Validate department name (unique)
    Service -> DeptRepo: 33. findByName(name)
    DeptRepo -> DB: 34. SELECT * FROM department WHERE name = ?
    DB --> DeptRepo: 35. Optional<Department>
    DeptRepo --> Service: 36. Optional (empty if new)

    alt Department name exists
        Service --> Controller: 37. Throw exception: "Department name already exists"
        Controller --> Gateway: 38. HTTP 400 Bad Request
        Gateway --> Frontend: 39. Error response
        Frontend --> User: 40. Display error message
    else Department name is unique
        Service -> Mapper: 41. toEntity(DTO, location, head)
        Mapper --> Service: 42. Department entity
        
        Service -> DeptRepo: 43. save(Department)
        DeptRepo -> DB: 44. INSERT INTO department\n(including department_head_id)
        DB --> DeptRepo: 45. Saved department
        DeptRepo --> Service: 46. Department
        
        Service -> Mapper: 47. toResponseDTO(Department)
        Mapper -> Mapper: 48. Extract departmentHeadId and departmentHeadName
        Mapper --> Service: 49. DepartmentResponseDTO\n(with departmentHeadId)
        
        Service --> Controller: 50. DepartmentResponseDTO
        Controller --> Gateway: 51. HTTP 201 Created
        Gateway --> Frontend: 52. Response with department data\n(including departmentHeadId)
    
    participant "Department Form Component" as FormComp
    participant "Table Component" as TableComp
    participant "Department List Component" as ListComp
    
    Frontend -> FormComp: 53. Emit departmentResponse (DialogData)
    FormComp -> TableComp: 54. Close dialog with response
    TableComp -> TableComp: 55. afterClosed() subscription triggers
    TableComp -> TableComp: 56. Dispatch 'departmentAdded' event
    TableComp -> ListComp: 57. Event listener receives 'departmentAdded'
    ListComp -> Gateway: 58. POST /api/departments (query with pagination)
    Gateway -> Controller: 59. Forward query request
    Controller -> Service: 60. query(page, size, sortBy, sortDir)
    Service -> DeptRepo: 61. findAll(pageable)
    DeptRepo -> DB: 62. SELECT * FROM department\nORDER BY ... LIMIT ... OFFSET ...
    DB --> DeptRepo: 63. Paginated departments\n(with department_head_id)
    DeptRepo --> Service: 64. Page<Department>
    Service -> Mapper: 65. toResponseDTO() for each department
    Mapper --> Service: 66. DepartmentResponseDTO[]\n(with departmentHeadId)
    Service --> Controller: 67. PaginatedResponseDTO<Department>
    Controller --> Gateway: 68. HTTP 200 OK
    Gateway --> ListComp: 69. Updated department list\n(with departmentHeadId)
    ListComp -> ListComp: 70. Update table data
    ListComp -> User: 71. Display updated department list\nwith new department included\n(including department head)
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  Only SYSTEM_ADMIN
  can create departments
  @PreAuthorize enforces
  this at method level
end note

note right of Service
  **Business Rules:**
  - Department name must be unique
  - Location must exist
  - Department head must exist (if provided)
  - Controller validates employee before
    passing to service
end note

note right of Frontend
  **Typeahead Component:**
  - Provides autocomplete search
  - Searches employees by name/email
  - Displays employee suggestions
  - Stores selected employee ID
  - Validates selection before submit
end note

note right of Mapper
  **Adapter Pattern:**
  Converts DTO â†” Entity
end note

note right of TableComp
  **Refresh Pattern (Add Operations):**
  - Table component opens add dialog
  - Form emits response via @Output
  - Table's afterClosed() dispatches event
  - List component listens and refreshes
  - Ensures single refresh call
end note

note right of ListComp
  **List Refresh:**
  - Single API call to query endpoint
  - Maintains pagination and sorting
  - Updates table data automatically
end note

@enduml

