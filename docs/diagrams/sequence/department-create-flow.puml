@startuml Department Create Flow
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Department Creation - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Department Controller" as Controller
participant "Department Service" as Service
participant "Department Mapper" as Mapper
participant "Department Repository" as DeptRepo
participant "Location Repository" as LocRepo
participant "Employee Repository" as EmpRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Fill department form (name, description, budget)
User -> Frontend: 2. Select location
User -> Frontend: 3. Optionally select department head
User -> Frontend: 4. Click "Create Department"

Frontend -> Gateway: 5. POST /api/departments\nAuthorization: Bearer {token}\n(DepartmentRequestDTO)
Gateway -> Gateway: 6. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 7. Intercept request
JwtFilter -> JwtFilter: 8. Validate JWT token
JwtFilter -> JwtFilter: 9. Extract role from token
JwtFilter -> Controller: 10. Forward request

Controller -> Controller: 11. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN'))

alt Insufficient permissions
    Controller --> Gateway: 12. HTTP 403 Forbidden
    Gateway --> Frontend: 13. Access denied
    Frontend --> User: 14. Show error message
else Authorized
    Controller -> SecurityService: 15. getCurrentUserRole()
    SecurityService --> Controller: 16. Role (must be 'SYSTEM_ADMIN')
    
    Controller -> Service: 17. create(DepartmentRequestDTO)

alt Department head is provided
    Service -> EmpRepo: 8. getById(departmentHeadId)
    EmpRepo -> DB: 9. SELECT * FROM employee WHERE id = ?
    DB --> EmpRepo: 10. Employee entity
    EmpRepo --> Service: 11. DepartmentHead
end

Service -> LocRepo: 12. getById(locationId)
LocRepo -> DB: 13. SELECT * FROM location WHERE id = ?
DB --> LocRepo: 14. Location entity
LocRepo --> Service: 15. Location

Service -> Service: 16. Validate department name (unique)
Service -> DeptRepo: 17. findByName(name)
DeptRepo -> DB: 18. SELECT * FROM department WHERE name = ?
DB --> DeptRepo: 19. Optional<Department>
DeptRepo --> Service: 20. Optional (empty if new)

alt Department name exists
    Service --> Controller: 18. Throw exception: "Department name already exists"
    Controller --> Gateway: 19. HTTP 400 Bad Request
    Gateway --> Frontend: 20. Error response
    Frontend --> User: 21. Display error message
else Department name is unique
    Service -> Mapper: 22. toEntity(DTO, location, head)
    Mapper --> Service: 23. Department entity
    
    Service -> DeptRepo: 24. save(Department)
    DeptRepo -> DB: 25. INSERT INTO department
    DB --> DeptRepo: 26. Saved department
    DeptRepo --> Service: 27. Department
    
    Service -> Mapper: 28. toResponseDTO(Department)
    Mapper --> Service: 29. DepartmentResponseDTO
    
    Service --> Controller: 30. DepartmentResponseDTO
    Controller --> Gateway: 31. HTTP 201 Created
    Gateway --> Frontend: 32. Response with department data
    
    participant "Department Form Component" as FormComp
    participant "Table Component" as TableComp
    participant "Department List Component" as ListComp
    
    Frontend -> FormComp: 33. Emit departmentResponse (DialogData)
    FormComp -> TableComp: 34. Close dialog with response
    TableComp -> TableComp: 35. afterClosed() subscription triggers
    TableComp -> TableComp: 36. Dispatch 'departmentAdded' event
    TableComp -> ListComp: 37. Event listener receives 'departmentAdded'
    ListComp -> Gateway: 38. POST /api/departments (query with pagination)
    Gateway -> Controller: 39. Forward query request
    Controller -> Service: 40. query(page, size, sortBy, sortDir)
    Service -> DeptRepo: 41. findAll(pageable)
    DeptRepo -> DB: 42. SELECT * FROM department\nORDER BY ... LIMIT ... OFFSET ...
    DB --> DeptRepo: 43. Paginated departments
    DeptRepo --> Service: 44. Page<Department>
    Service --> Controller: 45. PaginatedResponseDTO<Department>
    Controller --> Gateway: 46. HTTP 200 OK
    Gateway --> ListComp: 47. Updated department list
    ListComp -> ListComp: 48. Update table data
    ListComp -> User: 49. Display updated department list\nwith new department included
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  Only SYSTEM_ADMIN
  can create departments
  @PreAuthorize enforces
  this at method level
end note

note right of Service
  **Business Rules:**
  - Department name must be unique
  - Location must exist
  - Department head must exist (if provided)
end note

note right of Mapper
  **Adapter Pattern:**
  Converts DTO â†” Entity
end note

note right of TableComp
  **Refresh Pattern (Add Operations):**
  - Table component opens add dialog
  - Form emits response via @Output
  - Table's afterClosed() dispatches event
  - List component listens and refreshes
  - Ensures single refresh call
end note

note right of ListComp
  **List Refresh:**
  - Single API call to query endpoint
  - Maintains pagination and sorting
  - Updates table data automatically
end note

@enduml

