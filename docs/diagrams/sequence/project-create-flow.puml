@startuml Project Create - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Project Create - Sequence Diagram

actor "Department Manager" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Project Controller" as Controller
participant "Project Service" as Service
participant "Project Mapper" as Mapper
participant "Project Repository" as ProjRepo
participant "Department Repository" as DeptRepo
participant "Employee Repository" as EmpRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Navigate to Project Management page
User -> Frontend: 2. Click "Add Project" button
Frontend -> Frontend: 3. Display project creation form
User -> Frontend: 4. Fill project details\n(name, description, start date, budget)
User -> Frontend: 5. Select department
User -> Frontend: 6. Select project manager
User -> Frontend: 7. Click "Create Project"

Frontend -> Gateway: 8. POST /api/projects\n(ProjectRequestDTO)\nAuthorization: Bearer {token}

Gateway -> Gateway: 9. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 10. Intercept request
JwtFilter -> JwtFilter: 11. Validate JWT token
JwtFilter -> JwtFilter: 12. Extract role and department from token
JwtFilter -> JwtFilter: 13. Set SecurityContext
JwtFilter -> Controller: 14. Forward request

Controller -> Controller: 15. Check @PreAuthorize\n(hasRole('SYSTEM_ADMIN') or hasRole('DEPARTMENT_MANAGER'))

alt Insufficient permissions
    Controller --> Gateway: 16. HTTP 403 Forbidden
    Gateway --> Frontend: 17. Access denied
    Frontend --> User: 18. Show error message
else Authorized
    Controller -> SecurityService: 19. getCurrentUserRole()\ngetCurrentUserDepartmentId()
    SecurityService --> Controller: 20. Role, DepartmentId
    
    Controller -> Service: 21. create(ProjectRequestDTO, userRole, userDepartmentId)
    
    Service -> Service: 22. Validate input\n(name, description, budget, dates)
    
    alt Validation fails
        Service --> Controller: 23. Throw ValidationException
        Controller --> Gateway: 24. HTTP 400 Bad Request
        Gateway --> Frontend: 25. Error response
        Frontend --> User: 26. Show validation errors
    else Validation passes
        Service -> DeptRepo: 27. findById(departmentId)
        DeptRepo -> DB: 28. SELECT * FROM department WHERE id = ?
        DB --> DeptRepo: 29. Department data
        DeptRepo --> Service: 30. Department entity
        
        alt Department not found
            Service --> Controller: 31. Throw DepartmentNotFoundException
            Controller --> Gateway: 32. HTTP 404 Not Found
            Gateway --> Frontend: 33. Error response
            Frontend --> User: 34. Show error: "Department not found"
        else Department found
            alt Department Manager
                Service -> Service: 35. Check if departmentId == userDepartmentId
                
                alt Department not user's department
                    Service --> Controller: 36. Throw AccessDeniedException
                    Controller --> Gateway: 37. HTTP 403 Forbidden
                    Gateway --> Frontend: 38. Error response
                    Frontend --> User: 39. Show error: "You can only create projects in your department"
                end
            end
            
            Service -> EmpRepo: 40. findById(projectManagerId)
            EmpRepo -> DB: 41. SELECT * FROM employee WHERE id = ?
            DB --> EmpRepo: 42. Employee data
            EmpRepo --> Service: 43. Project Manager entity
            
            alt Project Manager not found
                Service --> Controller: 44. Throw EmployeeNotFoundException
                Controller --> Gateway: 45. HTTP 404 Not Found
                Gateway --> Frontend: 46. Error response
                Frontend --> User: 47. Show error: "Project Manager not found"
            else Project Manager found
                Service -> Mapper: 48. toEntity(DTO, department, projectManager)
                Mapper --> Service: 49. Project entity
                
                Service -> ProjRepo: 50. save(Project)
                ProjRepo -> DB: 51. INSERT INTO project\n(name, description, start_date, budget, department_id, project_manager_id)
                DB --> ProjRepo: 52. Saved project
                ProjRepo --> Service: 53. Project entity
                
                Service -> Mapper: 54. toResponseDTO(Project)
                Mapper --> Service: 55. ProjectResponseDTO
                
                Service --> Controller: 56. ProjectResponseDTO
                Controller --> Gateway: 57. HTTP 201 Created
                Gateway --> Frontend: 58. Response with project data
                Frontend -> User: 59. Display success: "Project created successfully"
                Frontend -> Frontend: 60. Redirect to project list or project details
            end
        end
    end
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts role and department
  - Sets SecurityContext
end note

note right of Controller
  **Authorization:**
  @PreAuthorize checks role
  Department Managers can only
  create projects in their department
end note

note right of Service
  **Business Rules:**
  - Department must exist
  - Project Manager must exist
  - Budget must be non-negative
  - Department Manager constraint
end note

@enduml

