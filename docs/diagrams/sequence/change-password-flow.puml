@startuml Change Password - Sequence Diagram
' Workflow test - updated
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Change Password - Sequence Diagram

actor "Authenticated User" as User
participant "Angular Frontend" as Frontend
participant "Nginx Gateway" as Gateway
participant "Auth Controller" as Controller
participant "Auth Service" as AuthService
participant "User Repository" as UserRepo
database "PostgreSQL" as DB

User -> Frontend: 1. Navigate to "Change Password" (Settings/Profile)
User -> Frontend: 2. Enter current password
User -> Frontend: 3. Enter new password
User -> Frontend: 4. Confirm new password
User -> Frontend: 5. Click "Change Password"

Frontend -> Frontend: 6. Validate form (client-side)\n- Password match\n- Min 8 characters
Frontend -> Frontend: 7. Hash current password (SHA-256)
Frontend -> Frontend: 8. Hash new password (SHA-256)
Frontend -> Gateway: 9. PUT /api/auth/change-password\n(ChangePasswordRequestDTO)\nAuthorization: Bearer {token}

Gateway -> Gateway: 10. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 11. Intercept request
JwtFilter -> JwtFilter: 12. Validate JWT token
JwtFilter -> JwtFilter: 13. Extract user ID from token
JwtFilter -> JwtFilter: 14. Set SecurityContext
JwtFilter -> Controller: 15. Forward request

Controller -> Controller: 16. Check authentication\n(User must be logged in)

Controller -> AuthService: 17. changePassword(userId, currentPassword, newPassword)

AuthService -> SecurityService: 18. getCurrentUserId()
SecurityService --> AuthService: 19. User ID from token

AuthService -> UserRepo: 20. findById(userId)
UserRepo -> DB: 21. SELECT * FROM users WHERE id = ?
DB --> UserRepo: 22. User data
UserRepo --> AuthService: 23. User entity

alt User not found
    AuthService --> Controller: 24. Throw UserNotFoundException
    Controller --> Gateway: 25. HTTP 404 Not Found
    Gateway --> Frontend: 26. Error response
    Frontend --> User: 27. Show error: "User not found"
else User found
    AuthService -> AuthService: 28. Verify current password\n(BCrypt.compare)\nDouble-hash comparison
    
    alt Current password incorrect
        AuthService --> Controller: 29. Throw InvalidPasswordException
        Controller --> Gateway: 30. HTTP 401 Unauthorized
        Gateway --> Frontend: 31. Error response
        Frontend --> User: 32. Show error: "Current password is incorrect"
    else Current password correct
        AuthService -> AuthService: 33. Validate new password\n- Min 8 characters\n- Different from current
        
        alt New password same as current
            AuthService --> Controller: 34. Throw ValidationException\n"New password must be different"
            Controller --> Gateway: 35. HTTP 400 Bad Request
            Gateway --> Frontend: 36. Error response
            Frontend --> User: 37. Show error: "New password must be different"
        else Valid new password
            AuthService -> AuthService: 38. Hash new password (BCrypt)\nDouble-hash: SHA-256 + BCrypt
            AuthService -> AuthService: 39. Update user password
            AuthService -> AuthService: 40. Set passwordUpdatedAt timestamp
            
            AuthService -> UserRepo: 41. save(User)
            UserRepo -> DB: 42. UPDATE users SET password = ? WHERE id = ?
            DB --> UserRepo: 43. Updated user
            UserRepo --> AuthService: 44. User entity
            
            AuthService --> Controller: 45. Success response
            
            Controller --> Gateway: 46. HTTP 200 OK
            Gateway --> Frontend: 47. Success response
            Frontend -> User: 48. Display success: "Password changed successfully"
            
            alt Security policy: Require re-login
                Frontend -> Frontend: 49. Clear token from localStorage
                Frontend -> Frontend: 50. Redirect to login page
            else Keep session active
                Frontend -> Frontend: 51. Keep user logged in
            end
        end
    end
end

note right of JwtFilter
  **RBAC:**
  - Validates JWT token
  - Extracts user ID
  - Sets SecurityContext
end note

note right of AuthService
  **Password Security:**
  - Current password: Verified with BCrypt
  - New password: Double-hash
    (SHA-256 + BCrypt)
  - Password must be different
    from current password
  - Min 8 characters required
end note

note right of Controller
  **Authorization:**
  User can only change
  their own password
  (validated via JWT user ID)
end note

@enduml

