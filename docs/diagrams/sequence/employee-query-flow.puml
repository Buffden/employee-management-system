@startuml Employee Query with Filters/Sorting - Sequence Diagram
skinparam linetype ortho
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60

title Employee Query with Filters, Sorting, Pagination - Sequence Diagram

actor "HR Manager" as User
participant "Angular Frontend" as Frontend
participant "Table Component" as Table
participant "Employee Service" as Service
participant "Nginx Gateway" as Gateway
participant "Employee Controller" as Controller
participant "Employee Query Service" as QueryService
participant "Sort Strategy Factory" as SortFactory
participant "Filter Strategy Factory" as FilterFactory
participant "Name Sort Strategy" as NameSort
participant "Department Filter Strategy" as DeptFilter
participant "Employee Repository" as Repository
database "PostgreSQL" as DB

User -> Table: 1. Apply filters (department, designation)
User -> Table: 2. Sort by column (name, salary)
User -> Table: 3. Change page (pagination)

Table -> Service: 4. queryEmployees(query: TableQueryRequest)
Service -> Gateway: 5. POST /api/employees/query\nAuthorization: Bearer {token}\n(filters, sortBy, sortDirection, page, size)
Gateway -> Gateway: 6. Forward to Backend

participant "JwtAuthenticationFilter" as JwtFilter
participant "SecurityService" as SecurityService

Gateway -> JwtFilter: 7. Intercept request
JwtFilter -> JwtFilter: 8. Validate JWT token
JwtFilter -> JwtFilter: 9. Extract role from token
JwtFilter -> Controller: 10. Forward request

Controller -> Controller: 11. Check @PreAuthorize\n(hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER', 'DEPARTMENT_MANAGER', 'EMPLOYEE'))
Controller -> SecurityService: 12. getCurrentUserRole()\ngetCurrentUserDepartmentId()\ngetCurrentUserId()
SecurityService --> Controller: 13. Role, DepartmentId, UserId

Controller -> QueryService: 14. query(TableQueryRequest, role, departmentId, userId)

alt Role is SYSTEM_ADMIN or HR_MANAGER
    QueryService -> Repository: 15. findAllFilteredByRole(role, null, null, pageable)
    Repository -> DB: 16. SELECT * FROM employee\n(no filtering)
    DB --> Repository: 17. All employees
else Role is DEPARTMENT_MANAGER
    QueryService -> Repository: 18. findAllFilteredByRole(role, departmentId, null, pageable)
    Repository -> DB: 19. SELECT * FROM employee\nWHERE department_id = ?
    DB --> Repository: 20. Department employees only
else Role is EMPLOYEE
    QueryService -> Repository: 21. findAllFilteredByRole(role, null, userId, pageable)
    Repository -> DB: 22. SELECT * FROM employee\nWHERE id = ?
    DB --> Repository: 23. Own record only
end

Repository --> QueryService: 24. Page<Employee>

QueryService -> QueryService: 25. toTableRowDTO(Employee)
QueryService --> QueryService: 26. List<EmployeeTableRowDTO>

loop For each filter
    QueryService -> FilterFactory: 27. createFilterStrategy(filterKey)
    FilterFactory --> QueryService: 28. FilterStrategy
    
    alt Department filter
        QueryService -> DeptFilter: 29. filter(data, "Engineering")
        DeptFilter --> QueryService: 30. Filtered data
    end
end

QueryService -> SortFactory: 31. createSortStrategy(sortBy, direction)
SortFactory --> QueryService: 32. SortStrategy

alt Sort by name
    QueryService -> NameSort: 33. sort(data, "ASC")
    NameSort --> QueryService: 34. Sorted data
end

QueryService -> QueryService: 35. applyPagination(data, page, size)
QueryService --> QueryService: 36. Page<EmployeeTableRowDTO>

QueryService --> Controller: 37. Page<EmployeeTableRowDTO>
Controller --> Gateway: 38. HTTP 200 OK
Gateway --> Service: 39. Response with paginated data
Service --> Table: 40. Employee data
Table -> User: 41. Display filtered, sorted, paginated table

note right of SecurityService
  **RBAC Filtering:**
  - SYSTEM_ADMIN/HR_MANAGER: All employees
  - DEPARTMENT_MANAGER: Own department only
  - EMPLOYEE: Own record only
end note

note right of Repository
  **Role-Based Query:**
  findAllFilteredByRole()
  automatically filters by
  role scope
end note

note right of QueryService
  Template Method Pattern:
  BaseTableQueryService defines
  algorithm structure
end note

note right of SortFactory
  Factory Method Pattern:
  Creates appropriate
  sort strategy
end note

note right of NameSort
  Strategy Pattern:
  Different sorting
  algorithms
end note

@enduml

