# Location Module - Low-Level Design

## 1. Overview

The Location module handles physical office location management including CRUD operations for locations where employees work and departments are based.

## 2. Entities

### 2.1 Location Entity

**Location**: `backend/src/main/java/com/ems/employee_management_system/models/Location.java`

**Fields**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | `UUID` | `@Id`, `@GeneratedValue` | Primary key |
| `name` | `String` | `@Column(nullable=false, unique=true)` | Location name (unique) |
| `address` | `String` | - | Street address |
| `city` | `String` | `@Column(nullable=false)` | City name |
| `state` | `String` | `@Column(nullable=false)` | State/Province |
| `country` | `String` | `@Column(nullable=false)`, Default: `"USA"` | Country |
| `postalCode` | `String` | - | ZIP/Postal code |

**Relationships**:
- Referenced by `Employee` (Many-to-One)
- Referenced by `Department` (Many-to-One)

## 3. DTOs

### 3.1 LocationRequestDTO

**Location**: `backend/src/main/java/com/ems/employee_management_system/dtos/LocationRequestDTO.java`

**Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `name` | `String` | Location name |
| `address` | `String` | Street address |
| `city` | `String` | City name |
| `state` | `String` | State/Province |
| `country` | `String` | Country (default: "USA") |
| `postalCode` | `String` | ZIP/Postal code |

**Note**: No `id` field (auto-generated on server side)

### 3.2 LocationResponseDTO

**Location**: `backend/src/main/java/com/ems/employee_management_system/dtos/LocationResponseDTO.java`

**Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `id` | `UUID` | Location unique identifier |
| `name` | `String` | Location name |
| `address` | `String` | Street address |
| `city` | `String` | City name |
| `state` | `String` | State/Province |
| `country` | `String` | Country |
| `postalCode` | `String` | ZIP/Postal code |

## 4. Controllers

### 4.1 LocationController

**Location**: `backend/src/main/java/com/ems/employee_management_system/controllers/LocationController.java`

**Endpoints**:

| Method | Endpoint | Description | Request | Response |
|--------|----------|-------------|---------|----------|
| GET | `/api/locations` | Get all locations | - | `List<LocationResponseDTO>` |
| GET | `/api/locations/{id}` | Get location by ID | - | `LocationResponseDTO` |
| POST | `/api/locations` | Create location | `LocationRequestDTO` | `LocationResponseDTO` |
| PUT | `/api/locations/{id}` | Update location | `LocationRequestDTO` | `LocationResponseDTO` |
| DELETE | `/api/locations/{id}` | Delete location | - | `void` |

**Dependencies**:
- `LocationService` - Business logic
- `LocationMapper` - Entity ↔ DTO conversion

**Patterns Applied**:
- **Adapter Pattern**: LocationMapper converts Entity ↔ DTO (similar to EmployeeMapper and DepartmentMapper pattern)

## 5. Services

### 5.1 LocationService

**Location**: `backend/src/main/java/com/ems/employee_management_system/services/LocationService.java`

**Methods**:

| Method | Parameters | Return Type | Description |
|--------|------------|-------------|-------------|
| `getAll()` | - | `List<Location>` | Get all locations |
| `getById(UUID id)` | `id` | `Location` | Get location by ID |
| `save(Location location)` | `location` | `Location` | Save location |
| `delete(UUID id)` | `id` | `void` | Delete location |

**Dependencies**:
- `LocationRepository` - Data access

**Patterns Applied**:
- **Adapter Pattern**: LocationMapper for Entity ↔ DTO conversions

## 6. Repositories

### 6.1 LocationRepository

**Location**: `backend/src/main/java/com/ems/employee_management_system/repositories/LocationRepository.java`

```java
@Repository
public interface LocationRepository extends JpaRepository<Location, UUID> {
    Optional<Location> findByName(String name);
}
```

**Methods**:
- `findAll()`: Get all locations (inherited from JpaRepository)
- `findById(UUID id)`: Get location by ID (inherited)
- `findByName(String name)`: Find location by name
- `save(Location location)`: Save location (inherited)
- `deleteById(UUID id)`: Delete location (inherited)

## 7. Mappers

### 7.1 LocationMapper

**Location**: `backend/src/main/java/com/ems/employee_management_system/mappers/LocationMapper.java`

**Pattern**: Adapter Pattern

**Methods**:

| Method | Parameters | Return Type | Description |
|--------|------------|-------------|-------------|
| `toResponseDTO(Location location)` | `location` | `LocationResponseDTO` | Convert Entity to Response DTO |
| `toEntity(LocationRequestDTO dto)` | `dto` | `Location` | Convert Request DTO to Entity (ID not set) |

**Responsibilities**:
- Maps Entity to Response DTO (includes id)
- Maps Request DTO to Entity (excludes id, auto-generated by JPA)

## 8. Design Patterns Summary

| Pattern | Location | Purpose |
|---------|----------|---------|
| **Adapter** | LocationMapper | Entity ↔ DTO conversion |

## 9. Validation Rules

- `name`: Required, max 100 characters, unique
- `city`: Required, max 100 characters
- `state`: Required, max 100 characters
- `country`: Required, max 100 characters, default: "USA"
- `address`: Optional, max 255 characters
- `postalCode`: Optional, max 20 characters

## 10. Business Rules

1. **Name Uniqueness**: Location name must be unique across all locations
2. **Referential Integrity**: Cannot delete location if referenced by employees or departments
3. **Default Country**: If country not provided, defaults to "USA"

## 10.1 Role-Based Access Control

| Operation | System Admin | HR Manager | Department Manager | Employee |
|-----------|--------------|------------|-------------------|----------|
| **View All Locations** | ✅ | ✅ | ✅ | ❌ |
| **View Location** | ✅ | ✅ | ✅ | ❌ |
| **Create Location** | ✅ | ✅ | ❌ | ❌ |
| **Update Location** | ✅ | ✅ | ❌ | ❌ |
| **Delete Location** | ✅ | ❌ | ❌ | ❌ |

### 10.1.1 Implementation Details

**Service Layer Authorization**:

**Example - LocationService**:
```java
@PreAuthorize("hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER')")
public LocationResponseDTO create(LocationRequestDTO dto) { ... }

@PreAuthorize("hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER')")
public LocationResponseDTO update(UUID id, LocationRequestDTO dto) { ... }

@PreAuthorize("hasRole('SYSTEM_ADMIN')")
public void delete(UUID id) {
    // Check if location is referenced by employees or departments
    if (locationRepository.countEmployeesByLocation(id) > 0 ||
        locationRepository.countDepartmentsByLocation(id) > 0) {
        throw new IllegalStateException("Cannot delete location with associated employees or departments");
    }
    // ... delete logic
}

@PreAuthorize("hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER', 'DEPARTMENT_MANAGER')")
public Page<LocationResponseDTO> getAll(Pageable pageable) {
    // All authenticated roles can view, but only System Admin and HR Manager can modify
    // Uses filtered repository method for consistency with other modules
    String role = securityService.getCurrentUserRole();
    return locationRepository.findAllFilteredByRole(role, pageable)
        .map(mapper::toResponseDTO);
}
```

**Controller Layer**:
```java
@PostMapping
@PreAuthorize("hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER')")
public ResponseEntity<LocationResponseDTO> create(@Valid @RequestBody LocationRequestDTO dto) { ... }

@PutMapping("/{id}")
@PreAuthorize("hasAnyRole('SYSTEM_ADMIN', 'HR_MANAGER')")
public ResponseEntity<LocationResponseDTO> update(@PathVariable UUID id, 
                                                   @Valid @RequestBody LocationRequestDTO dto) { ... }

@DeleteMapping("/{id}")
@PreAuthorize("hasRole('SYSTEM_ADMIN')")
public ResponseEntity<Void> delete(@PathVariable UUID id) { ... }
```

**Repository-Level Filtering**:
```java
@Query("SELECT l FROM Location l WHERE " +
       "(:role = 'SYSTEM_ADMIN' OR :role = 'HR_MANAGER') OR " +
       "(:role = 'DEPARTMENT_MANAGER') OR " +
       "(:role = 'EMPLOYEE')")
Page<Location> findAllFilteredByRole(@Param("role") String role,
                                     Pageable pageable);
```

**Note**: Location management is restricted to System Admin and HR Manager only. Department Managers and Employees have read-only access. All roles can view locations, but filtering is applied for consistency with other modules.

**See**: `docs/security/roles-and-permissions.md` for complete permission matrix

## 11. Sequence Diagram

See: `docs/diagrams/sequence/` (to be created for location operations)

## 12. Future Enhancements

- **Geographic Data**: Add latitude/longitude for mapping
- **Time Zone**: Associate time zone with location
- **Capacity**: Track maximum employee capacity
- **Facilities**: List of facilities/amenities at location

---

**Status**: Complete  
**Last Updated**: 2024-12-10

